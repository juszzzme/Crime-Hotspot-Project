{% extends "base.html" %}

{% block title %}CRIMESENSE - Advanced Crime Intelligence Platform{% endblock %}

{% block extra_css %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""/>

<!-- Leaflet Marker Cluster CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
    /* Project Color System */
    :root {
        /* Primary Colors */
        --primary-color: #3a7bd5;
        --primary-dark: #1e3c72;
        --secondary-color: #00d2ff;
        --success-color: #28a745;
        --danger-color: #dc3545;
        --warning-color: #ffc107;
        --dark-color: #2c3e50;
        --light-color: #f8f9fc;
        --border-radius: 12px;
        --box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
        
        /* UI Colors */
        --bg-primary: #ffffff;
        --bg-secondary: #f8f9fa;
        --text-primary: #2c3e50;
        --text-secondary: #6c757d;
        --border-color: #e3e6f0;

        /* Security Status Colors */
        --status-success: #228B22;
        --status-warning: #FF8C00;
        --status-critical: #DC143C;
        --status-info: #4682B4;

        /* Interactive States */
        --hover-lift: translateY(-2px);
        --active-scale: scale(0.98);
        --transition-smooth: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        --transition-quick: all 0.15s ease-out;
    }

    /* Global Reset with Project Aesthetics */
    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    body {
        font-family: 'Nunito', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        margin: 0;
        padding: 0;
        background: var(--light-color);
        color: var(--text-primary);
        line-height: 1.6;
        min-height: 100vh;
        font-weight: 400;
        letter-spacing: -0.01em;
        overflow-x: hidden;
    }

    /* Enhanced Header System */
    .header-container {
        background: var(--bg-secondary);
        backdrop-filter: blur(24px) saturate(180%);
        border-bottom: 1px solid var(--border-color);
        position: sticky;
        top: 0;
        z-index: 1000;
        transition: var(--transition-smooth);
    }

    .header-content {
        max-width: 1440px;
        margin: 0 auto;
        padding: 1.5rem 2rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .logo-section {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .logo-icon {
        width: 52px;
        height: 52px;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        box-shadow: var(--box-shadow);
        transition: var(--transition-smooth);
        position: relative;
    }

    .logo-icon::before {
        content: '';
        position: absolute;
        inset: -2px;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        border-radius: 18px;
        z-index: -1;
        opacity: 0;
        transition: var(--transition-smooth);
    }

    .logo-icon:hover::before {
        opacity: 0.5;
        animation: pulse-glow 2s ease-in-out infinite;
    }

    .logo-text {
        font-size: 1.875rem;
        font-weight: 800;
        background: linear-gradient(135deg, var(--text-primary), var(--text-secondary));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        letter-spacing: -0.02em;
    }

    .subtitle {
        color: var(--text-secondary);
        font-size: 0.875rem;
        font-weight: 500;
        margin-left: 0.25rem;
        opacity: 0.8;
    }

    /* Enhanced Navigation */
    .nav-controls {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .nav-item {
        padding: 0.75rem 1.5rem;
        background: var(--bg-glass);
        border: 1px solid var(--border-secondary);
        border-radius: 12px;
        color: var(--text-secondary);
        text-decoration: none;
        font-weight: 500;
        font-size: 0.875rem;
        transition: var(--transition-smooth);
        backdrop-filter: blur(10px);
        position: relative;
        overflow: hidden;
    }

    .nav-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
        transition: var(--transition-smooth);
    }

    .nav-item:hover {
        background: var(--bg-hover);
        border-color: var(--border-accent);
        color: var(--text-primary);
        transform: var(--hover-lift);
        box-shadow: var(--box-shadow);
    }

    .nav-item:hover::before {
        left: 100%;
    }

    .nav-item.active {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        border-color: var(--primary-color);
        color: var(--clutch-white);
        box-shadow: var(--box-shadow);
    }

    /* Hierarchical Navigation Breadcrumb */
    .breadcrumb-nav {
        background: var(--bg-elevated);
        border-bottom: 1px solid var(--border-color);
        padding: 1rem 2rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
    }

    .breadcrumb-item {
        color: var(--text-muted);
        text-decoration: none;
        transition: var(--transition-quick);
        cursor: pointer;
    }

    .breadcrumb-item:hover {
        color: var(--primary-color);
    }

    .breadcrumb-item.active {
        color: var(--text-primary);
        font-weight: 600;
    }

    .breadcrumb-separator {
        color: var(--text-muted);
        margin: 0 0.5rem;
    }

    /* Main Layout - Maximized for Better Map Visibility */
    .main-container {
        display: flex;
        min-height: calc(100vh - 60px);
        position: relative;
        background: var(--bg-primary);
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        margin: 1rem auto;
        max-width: 1400px;
        overflow: hidden;
    }

    /* Enhanced Sidebar with Project Aesthetics */
    .sidebar {
        width: 320px;
        background: var(--bg-secondary);
        border-right: 1px solid var(--border-color);
        padding: 1.5rem;
        overflow-y: auto;
        transition: all 0.3s ease;
        position: relative;
        z-index: 10;
        background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
    }

    .sidebar-section {
        margin-bottom: 2.5rem;
    }

    .sidebar-section:last-child {
        margin-bottom: 0;
    }

    .section-header {
        font-size: 1.125rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 1.25rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid var(--primary-color);
        display: flex;
        align-items: center;
        gap: 0.75rem;
        letter-spacing: -0.01em;
    }

    .section-icon {
        font-size: 1.125rem;
        color: var(--primary-color);
        display: flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
    }

    /* Map Container - Security Platform Style */
    .map-container {
        background: var(--bg-surface);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        overflow: hidden;
        box-shadow: var(--box-shadow);
        backdrop-filter: blur(24px) saturate(180%);
        display: flex;
        flex-direction: column;
        position: relative;
    }

    .map-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(90deg, var(--primary-color), var(--secondary-color), var(--primary-color));
        z-index: 1;
    }

    .map-header {
        padding: 1.5rem 2rem;
        background: var(--bg-elevated);
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
    }

    .map-title {
        font-size: 1.375rem;
        font-weight: 700;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 0.75rem;
        letter-spacing: -0.02em;
    }

    .map-controls {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    .control-btn {
        width: 44px;
        height: 44px;
        background: var(--bg-glass);
        border: 1px solid var(--border-secondary);
        border-radius: 12px;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: var(--transition-smooth);
        backdrop-filter: blur(10px);
    }

    .control-btn:hover {
        background: var(--bg-hover);
        color: var(--primary-color);
        border-color: var(--border-accent);
        transform: var(--hover-lift);
        box-shadow: var(--box-shadow);
    }

    .map-content {
        flex: 1;
        position: relative;
        min-height: 800px;
        background: var(--beige-primary); /* Light beige background for optimal map visibility */
    }

    #map {
        width: 100%;
        height: 100%;
        border-radius: 0;
    }

    /* State Selection Buttons in Sidebar */
    .state-selection-section {
        margin-bottom: 2rem;
    }

    .state-buttons-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 0.75rem;
    }

    .state-btn {
        padding: 1rem 1.25rem;
        background: var(--bg-glass);
        border: 1px solid var(--border-primary);
        border-radius: 12px;
        color: var(--text-primary);
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition-smooth);
        text-align: left;
        backdrop-filter: blur(20px);
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 0.875rem;
    }

    .state-btn:hover {
        background: var(--bg-hover);
        border-color: var(--primary-blue);
        transform: var(--hover-lift);
        box-shadow: var(--shadow-medium);
        color: var(--primary-blue);
    }

    .state-btn.active {
        background: linear-gradient(135deg, var(--primary-blue), var(--accent-blue));
        border-color: var(--primary-blue);
        color: var(--pure-white);
        box-shadow: var(--shadow-glow);
    }

    .state-icon {
        font-size: 1.125rem;
        width: 24px;
        text-align: center;
    }

    /* Loading System */
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(10, 10, 10, 0.9);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(12px);
        z-index: 1000;
    }

    .loading-spinner {
        width: 48px;
        height: 48px;
        border: 3px solid var(--border-secondary);
        border-top: 3px solid var(--primary-blue);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 1.5rem;
    }

    .loading-text {
        color: var(--text-secondary);
        font-size: 0.875rem;
        font-weight: 500;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    @keyframes pulse-glow {
        0%, 100% { box-shadow: var(--shadow-glow); }
        50% { box-shadow: 0 0 40px rgba(0, 102, 255, 0.4); }
    }

    /* Responsive Design */
    @media (max-width: 1200px) {
        .main-container {
            grid-template-columns: 300px 1fr;
            gap: 1.25rem;
            padding: 1rem 1.5rem 1rem 1.5rem;
        }
    }

    @media (max-width: 968px) {
        .main-container {
            grid-template-columns: 1fr;
            gap: 1rem;
            padding: 0.75rem;
            min-height: calc(100vh - 80px);
        }

        .sidebar {
            order: 2;
        }

        .map-container {
            order: 1;
        }

        .map-content {
            min-height: 640px;
        }

        .header-content {
            flex-direction: column;
            gap: 1rem;
            padding: 1rem 1.5rem;
        }

        .state-buttons-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }
    }

    @media (max-width: 640px) {
        .state-buttons-grid {
            grid-template-columns: 1fr;
        }

        .map-content {
            min-height: 560px;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="hero-section" style="background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); padding: 5rem 0; margin-bottom: 2rem; color: white;">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-6">
                <h1 class="display-4 fw-bold mb-3">Interactive Crime Map</h1>
                <p class="lead mb-4" style="color: white;">Explore real-time crime data and statistics with our advanced mapping tool. Analyze patterns, view hotspots, and stay informed about safety in your area.</p>
                <div class="d-flex gap-3">
                    <button class="btn btn-primary btn-lg px-4">
                        <i class="fas fa-map-marker-alt me-2"></i>View My Location
                    </button>
                    <button class="btn btn-outline-light btn-lg px-4">
                        <i class="fas fa-chart-line me-2"></i>View Analytics
                    </button>
                </div>
                <div class="mt-4 d-flex flex-wrap gap-2">
                    <span class="badge bg-white text-dark p-2"><i class="fas fa-shield-alt me-1"></i> Safety Tips</span>
                    <span class="badge bg-white text-dark p-2"><i class="fas fa-bullseye me-1"></i> Hotspots</span>
                    <span class="badge bg-white text-dark p-2"><i class="fas fa-chart-pie me-1"></i> Statistics</span>
                </div>
            </div>
            <div class="col-lg-6 d-none d-lg-block">
                <div class="position-relative" style="height: 300px; background: rgba(255,255,255,0.1); border-radius: 16px; overflow: hidden;">
                    <div class="position-absolute w-100 h-100 d-flex align-items-center justify-content-center">
                        <i class="fas fa-map-marked-alt" style="font-size: 8rem; opacity: 0.2;"></i>
                    </div>
                    <div class="position-absolute top-0 start-0 w-100 h-100 p-4">
                        <div class="card bg-white bg-opacity-10 border-0 text-white" style="backdrop-filter: blur(10px);">
                            <div class="card-body">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="bg-primary bg-opacity-25 p-2 rounded-circle me-3">
                                        <i class="fas fa-exclamation-triangle"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-0">High Alert Zone</h6>
                                        <small class="text-white-50">Increased activity detected</small>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <small class="d-block text-white-50">Last Updated</small>
                                        <span class="fw-bold">Just now</span>
                                    </div>
                                    <button class="btn btn-sm btn-light">View Details</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hierarchical Navigation Breadcrumb -->
<div class="breadcrumb-nav">
    <a href="/map" class="breadcrumb-item" id="country-breadcrumb">India</a>
    <span class="breadcrumb-separator" id="state-separator" style="display: none;">></span>
    <a href="#" class="breadcrumb-item" id="state-breadcrumb" style="display: none;"></a>
    <span class="breadcrumb-separator" id="city-separator" style="display: none;">></span>
    <span class="breadcrumb-item active" id="city-breadcrumb" style="display: none;"></span>
</div>

<div class="main-container">
    <!-- Enhanced Sidebar with Clutch Aesthetics -->
    <aside class="sidebar">
        <!-- Location Info -->
        <div class="sidebar-section">
            <div class="section-header">
                <span class="section-icon">üèõÔ∏è</span>
                <span id="location-title">{{ location_name or "India" }}</span>
            </div>
        </div>

        <!-- State Selection (Country View Only) -->
        <div class="sidebar-section state-selection-section" id="state-selection-section">
            <div class="section-header">
                <span class="section-icon">üó∫Ô∏è</span>
                Select State
            </div>

            <div class="state-buttons-grid">
                <button class="state-btn" data-state="tamil-nadu">
                    <span class="state-icon">üèõÔ∏è</span>
                    <span>Tamil Nadu</span>
                </button>
                <button class="state-btn" data-state="karnataka">
                    <span class="state-icon">üè¢</span>
                    <span>Karnataka</span>
                </button>
                <button class="state-btn" data-state="delhi">
                    <span class="state-icon">üèõÔ∏è</span>
                    <span>Delhi</span>
                </button>
                <button class="state-btn" data-state="maharashtra">
                    <span class="state-icon">üèôÔ∏è</span>
                    <span>Maharashtra</span>
                </button>
                <button class="state-btn" data-state="kerala">
                    <span class="state-icon">üå¥</span>
                    <span>Kerala</span>
                </button>
                <button class="state-btn" data-state="gujarat">
                    <span class="state-icon">üè≠</span>
                    <span>Gujarat</span>
                </button>
            </div>
        </div>

        <!-- City Selection (State View Only) -->
        <div class="sidebar-section city-selection-section" id="city-selection-section" style="display: none;">
            <div class="section-header">
                <span class="section-icon">üèôÔ∏è</span>
                Select City
            </div>

            <div class="state-buttons-grid" id="city-buttons-container">
                <!-- Cities will be populated dynamically -->
            </div>
        </div>

        <!-- Intelligence Filters -->
        <div class="sidebar-section">
            <div class="section-header">
                <span class="section-icon">üîç</span>
                Intelligence Filters
            </div>

            <div class="filter-group" style="margin-bottom: 1.25rem;">
                <label class="filter-label" style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.5rem;">Threat Classification</label>
                <select class="filter-select" id="threat-classification" style="width: 100%; padding: 0.75rem; background: var(--bg-glass); border: 1px solid var(--border-primary); border-radius: 8px; color: var(--text-primary); font-size: 0.875rem;">
                    <option value="all">All Classifications</option>
                    <option value="violent">Violent Crimes</option>
                    <option value="property">Property Crimes</option>
                    <option value="cyber">Cyber Crimes</option>
                    <option value="drug">Drug Offenses</option>
                    <option value="traffic">Traffic Violations</option>
                </select>
            </div>

            <div class="filter-group" style="margin-bottom: 1.25rem;">
                <label class="filter-label" style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.5rem;">Time Window</label>
                <select class="filter-select" id="time-window" style="width: 100%; padding: 0.75rem; background: var(--bg-glass); border: 1px solid var(--border-primary); border-radius: 8px; color: var(--text-primary); font-size: 0.875rem;">
                    <option value="realtime">Real-time</option>
                    <option value="24h">Last 24 Hours</option>
                    <option value="7d">Last 7 Days</option>
                    <option value="30d">Last 30 Days</option>
                    <option value="90d">Last 90 Days</option>
                </select>
            </div>

            <div class="filter-group" style="margin-bottom: 1.25rem;">
                <label class="filter-label" style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.5rem;">Severity Level</label>
                <select class="filter-select" id="severity-level" style="width: 100%; padding: 0.75rem; background: var(--bg-glass); border: 1px solid var(--border-primary); border-radius: 8px; color: var(--text-primary); font-size: 0.875rem;">
                    <option value="all">All Levels</option>
                    <option value="critical">Critical</option>
                    <option value="high">High</option>
                    <option value="medium">Medium</option>
                    <option value="low">Low</option>
                </select>
            </div>
        </div>
    </aside>

    <!-- Main Map Container -->
    <main class="map-container">
        <div class="map-header">
            <h1 class="map-title">
                <span>üó∫Ô∏è</span>
                <span id="map-title-text">Crime Intelligence Map</span>
            </h1>
            <div class="map-controls">
                <button class="control-btn" id="zoom-in" title="Zoom In">+</button>
                <button class="control-btn" id="zoom-out" title="Zoom Out">-</button>
                <button class="control-btn" id="reset-view" title="Reset View">‚åÇ</button>
                <button class="control-btn" id="fullscreen" title="Fullscreen">‚õ∂</button>
            </div>
        </div>

        <div class="map-content">
            <div id="map"></div>

            <!-- Loading Overlay -->
            <div class="loading-overlay" id="loading" style="display: none;">
                <div class="loading-spinner"></div>
                <div class="loading-text">Loading intelligence data...</div>
            </div>


        </div>
    </main>
</div>
{% endblock %}

{% block extra_js %}
<!-- Leaflet JavaScript -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>

<!-- Leaflet Marker Cluster JavaScript -->
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

<script>
// Global Application State
window.CrimeSenseApp = {
    map: null,
    currentLevel: 'country', // 'country', 'state', 'city'
    currentState: null,
    currentCity: null,
    markers: [],
    geoJsonLayer: null,
    clusterGroup: null,

    // Application Configuration
    config: {
        defaultCenter: [20.5937, 78.9629], // Center of India
        defaultZoom: 5,
        stateZoom: 7,
        cityZoom: 11,

        // State configurations
        states: {
            'tamil-nadu': {
                name: 'Tamil Nadu',
                center: [11.1271, 78.6569],
                zoom: 7,
                cities: [
                    { id: 'chennai', name: 'Chennai', icon: 'üèôÔ∏è' },
                    { id: 'coimbatore', name: 'Coimbatore', icon: 'üè≠' },
                    { id: 'madurai', name: 'Madurai', icon: 'üèõÔ∏è' }
                ]
            },
            'karnataka': {
                name: 'Karnataka',
                center: [15.3173, 75.7139],
                zoom: 7,
                cities: [
                    { id: 'bangalore', name: 'Bangalore', icon: 'üíª' },
                    { id: 'mysore', name: 'Mysore', icon: 'üè∞' },
                    { id: 'hubli', name: 'Hubli', icon: 'üè¢' }
                ]
            },
            'delhi': {
                name: 'Delhi',
                center: [28.7041, 77.1025],
                zoom: 10,
                cities: [
                    { id: 'new-delhi', name: 'New Delhi', icon: 'üèõÔ∏è' },
                    { id: 'old-delhi', name: 'Old Delhi', icon: 'üïå' }
                ]
            },
            'maharashtra': {
                name: 'Maharashtra',
                center: [19.7515, 75.7139],
                zoom: 7,
                cities: [
                    { id: 'mumbai', name: 'Mumbai', icon: 'üèôÔ∏è' },
                    { id: 'pune', name: 'Pune', icon: 'üéì' },
                    { id: 'nagpur', name: 'Nagpur', icon: 'üçä' }
                ]
            },
            'kerala': {
                name: 'Kerala',
                center: [10.8505, 76.2711],
                zoom: 7,
                cities: [
                    { id: 'kochi', name: 'Kochi', icon: '‚õµ' },
                    { id: 'thiruvananthapuram', name: 'Thiruvananthapuram', icon: 'üèõÔ∏è' },
                    { id: 'kozhikode', name: 'Kozhikode', icon: 'üèñÔ∏è' }
                ]
            },
            'gujarat': {
                name: 'Gujarat',
                center: [23.0225, 72.5714],
                zoom: 7,
                cities: [
                    { id: 'ahmedabad', name: 'Ahmedabad', icon: 'üè≠' },
                    { id: 'surat', name: 'Surat', icon: 'üíé' },
                    { id: 'vadodara', name: 'Vadodara', icon: 'üè¢' }
                ]
            }
        },

        // City configurations
        cities: {
            'chennai': {
                name: 'Chennai',
                state: 'tamil-nadu',
                center: [13.0827, 80.2707],
                zoom: 11
            }
        }
    }
};

// Initialize the application
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Initializing CRIMESENSE Advanced Intelligence Platform...');

    // Initialize map
    initializeMap();

    // Setup event listeners
    setupEventListeners();

    // Determine initial view based on URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const viewType = '{{ view_type }}' || 'country';
    const locationId = '{{ location_id }}' || null;

    // Load appropriate view
    switch(viewType) {
        case 'country':
            loadCountryView();
            break;
        case 'state':
            if (locationId) {
                loadStateView(locationId);
            } else {
                loadCountryView();
            }
            break;
        case 'city':
            const stateId = '{{ state_name }}' || null;
            if (locationId && stateId) {
                loadCityView(stateId, locationId);
            } else {
                loadCountryView();
            }
            break;
        default:
            loadCountryView();
    }

    console.log('‚úÖ CRIMESENSE Platform initialized successfully');
});

function initializeMap() {
    // Initialize Leaflet map
    window.CrimeSenseApp.map = L.map('map', {
        center: window.CrimeSenseApp.config.defaultCenter,
        zoom: window.CrimeSenseApp.config.defaultZoom,
        zoomControl: false, // We'll use custom controls
        attributionControl: true
    });

    // Add OpenStreetMap tile layer to match advanced map
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 19
    }).addTo(window.CrimeSenseApp.map);

    // Initialize marker cluster group for infrastructure markers
    window.CrimeSenseApp.clusterGroup = L.markerClusterGroup({
        chunkedLoading: true,
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false,
        zoomToBoundsOnClick: true,
        maxClusterRadius: 50,
        iconCreateFunction: function(cluster) {
            const childCount = cluster.getChildCount();
            let className = 'marker-cluster-small';
            if (childCount < 10) {
                className = 'marker-cluster-small';
            } else if (childCount < 100) {
                className = 'marker-cluster-medium';
            } else {
                className = 'marker-cluster-large';
            }

            return new L.DivIcon({
                html: '<div><span>' + childCount + '</span></div>',
                className: 'marker-cluster ' + className,
                iconSize: new L.Point(40, 40)
            });
        }
    });

    // Add cluster group to map
    window.CrimeSenseApp.map.addLayer(window.CrimeSenseApp.clusterGroup);

    console.log('üó∫Ô∏è Map initialized with clustering and security theme');
}

function setupEventListeners() {
    // State selection buttons in sidebar
    document.querySelectorAll('.state-btn[data-state]').forEach(btn => {
        btn.addEventListener('click', function() {
            const stateId = this.getAttribute('data-state');
            navigateToState(stateId);
        });
    });

    // Map control buttons
    document.getElementById('zoom-in')?.addEventListener('click', () => {
        window.CrimeSenseApp.map.zoomIn();
    });

    document.getElementById('zoom-out')?.addEventListener('click', () => {
        window.CrimeSenseApp.map.zoomOut();
    });

    document.getElementById('reset-view')?.addEventListener('click', () => {
        resetMapView();
    });

    document.getElementById('fullscreen')?.addEventListener('click', () => {
        toggleFullscreen();
    });

    // Breadcrumb navigation
    document.getElementById('country-breadcrumb')?.addEventListener('click', () => {
        navigateToCountry();
    });

    document.getElementById('state-breadcrumb')?.addEventListener('click', () => {
        if (window.CrimeSenseApp.currentState) {
            navigateToState(window.CrimeSenseApp.currentState);
        }
    });

    // Filter controls
    document.getElementById('threat-classification')?.addEventListener('change', applyFilters);
    document.getElementById('time-window')?.addEventListener('change', applyFilters);
    document.getElementById('severity-level')?.addEventListener('change', applyFilters);

    console.log('üéõÔ∏è Event listeners configured');
}

// Navigation Functions
function loadCountryView() {
    console.log('üìç Loading Country View: India');

    window.CrimeSenseApp.currentLevel = 'country';
    window.CrimeSenseApp.currentState = null;
    window.CrimeSenseApp.currentCity = null;

    // Update UI
    updateBreadcrumb('India');
    updateLocationTitle('India');
    updateMapTitle('Crime Intelligence Map - India');

    // Show state selection in sidebar, hide city selection
    document.getElementById('state-selection-section').style.display = 'block';
    document.getElementById('city-selection-section').style.display = 'none';

    // Reset map view
    window.CrimeSenseApp.map.setView(window.CrimeSenseApp.config.defaultCenter, window.CrimeSenseApp.config.defaultZoom);

    // Clear existing layers
    clearMapLayers();

    // Add country-level crime data
    addCountryCrimeData();

    // Clear active state buttons
    document.querySelectorAll('.state-btn').forEach(btn => {
        btn.classList.remove('active');
    });
}

function navigateToState(stateId) {
    console.log(`üìç Navigating to State: ${stateId}`);

    const stateConfig = window.CrimeSenseApp.config.states[stateId];
    if (!stateConfig) {
        console.error(`State configuration not found: ${stateId}`);
        return;
    }

    showLoading();

    setTimeout(() => {
        loadStateView(stateId);
        hideLoading();
    }, 1000);
}

function loadStateView(stateId) {
    console.log(`üìç Loading State View: ${stateId}`);

    const stateConfig = window.CrimeSenseApp.config.states[stateId];
    if (!stateConfig) return;

    window.CrimeSenseApp.currentLevel = 'state';
    window.CrimeSenseApp.currentState = stateId;
    window.CrimeSenseApp.currentCity = null;

    // Update UI
    updateBreadcrumb('India', stateConfig.name);
    updateLocationTitle(stateConfig.name);
    updateMapTitle(`Crime Intelligence Map - ${stateConfig.name}`);

    // Hide state selection, show city selection
    document.getElementById('state-selection-section').style.display = 'none';
    document.getElementById('city-selection-section').style.display = 'block';

    // Populate city buttons
    populateCityButtons(stateConfig.cities);

    // Update map view
    window.CrimeSenseApp.map.setView(stateConfig.center, stateConfig.zoom);

    // Clear existing layers
    clearMapLayers();

    // Load state GeoJSON and crime data
    loadStateGeoJSON(stateId);
    addStateCrimeData(stateId);

    // Mark active state button
    document.querySelectorAll('.state-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('data-state') === stateId) {
            btn.classList.add('active');
        }
    });

    // Update URL
    window.history.pushState({}, '', `/map/state/${stateId}`);
}

function navigateToCity(stateId, cityId) {
    console.log(`üìç Navigating to City: ${cityId} in ${stateId}`);

    showLoading();

    // For Chennai, redirect to dedicated city page
    if (cityId === 'chennai') {
        setTimeout(() => {
            window.location.href = `/chennai-city`;
        }, 800);
        return;
    }

    // For other cities, redirect to general city page
    setTimeout(() => {
        window.location.href = `/map/city/${stateId}/${cityId}`;
    }, 800);
}

function loadCityView(stateId, cityId) {
    console.log(`üìç Loading City View: ${cityId}`);

    const stateConfig = window.CrimeSenseApp.config.states[stateId];
    const cityConfig = window.CrimeSenseApp.config.cities[cityId];

    if (!stateConfig || !cityConfig) return;

    window.CrimeSenseApp.currentLevel = 'city';
    window.CrimeSenseApp.currentState = stateId;
    window.CrimeSenseApp.currentCity = cityId;

    // Update UI
    updateBreadcrumb('India', stateConfig.name, cityConfig.name);
    updateLocationTitle(`${cityConfig.name}, ${stateConfig.name}`);
    updateMapTitle(`Crime Intelligence Map - ${cityConfig.name}`);

    // Update map view
    window.CrimeSenseApp.map.setView(cityConfig.center, cityConfig.zoom);

    // Clear existing layers
    clearMapLayers();

    // Load city GeoJSON and comprehensive crime data
    loadCityGeoJSON(cityId);
    addCityCrimeData(cityId);
    addCityInfrastructure(cityId);

    // Update stats for city
    updateStats({
        activeIncidents: '89',
        threatLevel: '3.2%',
        riskZones: '3',
        securityScore: '8.7+'
    });

    // Update URL
    window.history.pushState({}, '', `/map/city/${stateId}/${cityId}`);
}

function navigateToCountry() {
    console.log('üìç Navigating back to Country View');

    showLoading();

    setTimeout(() => {
        loadCountryView();
        hideLoading();
        window.history.pushState({}, '', '/map');
    }, 800);
}

// UI Update Functions
function updateBreadcrumb(country, state = null, city = null) {
    // Reset all breadcrumb items
    document.getElementById('country-breadcrumb').className = 'breadcrumb-item';
    document.getElementById('state-breadcrumb').style.display = 'none';
    document.getElementById('city-breadcrumb').style.display = 'none';
    document.getElementById('state-separator').style.display = 'none';
    document.getElementById('city-separator').style.display = 'none';

    if (city) {
        // City view: India > State > City
        document.getElementById('state-breadcrumb').textContent = state;
        document.getElementById('state-breadcrumb').style.display = 'inline';
        document.getElementById('city-breadcrumb').textContent = city;
        document.getElementById('city-breadcrumb').style.display = 'inline';
        document.getElementById('state-separator').style.display = 'inline';
        document.getElementById('city-separator').style.display = 'inline';
        document.getElementById('city-breadcrumb').className = 'breadcrumb-item active';
    } else if (state) {
        // State view: India > State
        document.getElementById('state-breadcrumb').textContent = state;
        document.getElementById('state-breadcrumb').style.display = 'inline';
        document.getElementById('state-separator').style.display = 'inline';
        document.getElementById('state-breadcrumb').className = 'breadcrumb-item active';
    } else {
        // Country view: India
        document.getElementById('country-breadcrumb').className = 'breadcrumb-item active';
    }
}

function updateLocationTitle(title) {
    document.getElementById('location-title').textContent = title;
}

function updateMapTitle(title) {
    document.getElementById('map-title-text').textContent = title;
}

function populateCityButtons(cities) {
    const container = document.getElementById('city-buttons-container');
    container.innerHTML = '';

    cities.forEach(city => {
        const button = document.createElement('button');
        button.className = 'state-btn';
        button.setAttribute('data-city', city.id);
        button.innerHTML = `
            <span class="state-icon">${city.icon}</span>
            <span>${city.name}</span>
        `;
        button.addEventListener('click', () => {
            navigateToCity(window.CrimeSenseApp.currentState, city.id);
        });
        container.appendChild(button);
    });
}

// Data Loading Functions
function addCountryCrimeData() {
    // Add sample country-level crime markers
    const countryData = [
        { lat: 28.6139, lng: 77.2090, type: 'violent', severity: 'high', location: 'Delhi' },
        { lat: 19.0760, lng: 72.8777, type: 'property', severity: 'medium', location: 'Mumbai' },
        { lat: 13.0827, lng: 80.2707, type: 'cyber', severity: 'high', location: 'Chennai' },
        { lat: 12.9716, lng: 77.5946, type: 'drug', severity: 'medium', location: 'Bangalore' },
        { lat: 22.5726, lng: 88.3639, type: 'violent', severity: 'low', location: 'Kolkata' },
        { lat: 23.0225, lng: 72.5714, type: 'property', severity: 'medium', location: 'Ahmedabad' }
    ];

    countryData.forEach(crime => {
        addCrimeMarker(crime);
    });
}

function addStateCrimeData(stateId) {
    // Add state-specific crime data
    const stateData = {
        'tamil-nadu': [
            { lat: 13.0827, lng: 80.2707, type: 'violent', severity: 'high', location: 'Chennai Central' },
            { lat: 11.0168, lng: 76.9558, type: 'property', severity: 'medium', location: 'Coimbatore' },
            { lat: 9.9252, lng: 78.1198, type: 'cyber', severity: 'low', location: 'Madurai' }
        ]
    };

    const data = stateData[stateId] || [];
    data.forEach(crime => {
        addCrimeMarker(crime);
    });
}

function addCityCrimeData(cityId) {
    // Basic Interactive Map - NO crime markers, only infrastructure
    console.log(`üìç Basic map view for ${cityId} - crime markers disabled, showing infrastructure only`);
    // This function intentionally does nothing to keep the basic map clean
}

function addCityInfrastructure(cityId) {
    // Add hospitals, police stations, etc. for city view
    const infrastructure = {
        'chennai': {
            hospitals: [
                { lat: 13.0569, lng: 80.2425, name: 'Apollo Hospital Chennai' },
                { lat: 13.0878, lng: 80.2785, name: 'Fortis Malar Hospital' },
                { lat: 13.0827, lng: 80.2707, name: 'MIOT International' },
                { lat: 13.0067, lng: 80.2206, name: 'Sri Ramachandra Medical Centre' },
                { lat: 13.1185, lng: 80.2574, name: 'Government General Hospital' },
                { lat: 13.0732, lng: 80.2609, name: 'Vijaya Hospital' }
            ],
            policeStations: [
                { lat: 13.0827, lng: 80.2707, name: 'T. Nagar Police Station' },
                { lat: 13.0878, lng: 80.2785, name: 'Anna Nagar Police Station' },
                { lat: 13.0569, lng: 80.2425, name: 'Adyar Police Station' },
                { lat: 13.1185, lng: 80.2574, name: 'Egmore Police Station' },
                { lat: 13.0732, lng: 80.2609, name: 'Mylapore Police Station' }
            ],
            fireStations: [
                { lat: 13.0827, lng: 80.2707, name: 'Chennai Fire Station - Central' },
                { lat: 13.0878, lng: 80.2785, name: 'Anna Nagar Fire Station' },
                { lat: 13.0569, lng: 80.2425, name: 'Adyar Fire Station' }
            ]
        },
        'bangalore': {
            hospitals: [
                { lat: 12.9716, lng: 77.5946, name: 'Manipal Hospital' },
                { lat: 12.9698, lng: 77.7500, name: 'Apollo Hospital Bangalore' },
                { lat: 12.9279, lng: 77.6271, name: 'Fortis Hospital' }
            ],
            policeStations: [
                { lat: 12.9716, lng: 77.5946, name: 'Bangalore City Police Station' },
                { lat: 12.9698, lng: 77.7500, name: 'Electronic City Police Station' }
            ]
        }
    };

    const data = infrastructure[cityId];
    if (data) {
        // Add hospital markers
        data.hospitals?.forEach(hospital => {
            addInfrastructureMarker(hospital, 'hospital');
        });

        // Add police station markers
        data.policeStations?.forEach(station => {
            addInfrastructureMarker(station, 'police');
        });

        // Add fire station markers
        data.fireStations?.forEach(station => {
            addInfrastructureMarker(station, 'fire');
        });
    }
}

// Duplicate function removed - crime markers disabled for basic interactive map



// Helper function to get color for crime type (from original backup)
function getColorForCrimeType(crimeType) {
    const colors = {
        'theft': '#3498db',      // Blue
        'assault': '#e74c3c',    // Red
        'burglary': '#f39c12',   // Orange
        'robbery': '#9b59b6',    // Purple
        'homicide': '#c0392b',   // Dark Red
        'violent': '#e74c3c',    // Red
        'property': '#f39c12',   // Orange
        'cyber': '#9b59b6',      // Purple
        'drug': '#c0392b',       // Dark Red
        'default': '#2c3e50'     // Dark Blue (default)
    };

    return colors[crimeType.toLowerCase()] || colors.default;
}

function addCrimeMarker(crime) {
    // Use original authentic circle markers from backup
    const marker = L.circleMarker([crime.lat, crime.lng], {
        radius: 8,
        fillColor: getColorForCrimeType(crime.type),
        color: '#fff',
        weight: 1,
        opacity: 1,
        fillOpacity: 0.8
    });

    marker.bindPopup(`
        <div class="crime-popup">
            <h6>${crime.type.toUpperCase()}</h6>
            <p><strong>Location:</strong> ${crime.location}</p>
            <p><strong>Severity:</strong> ${crime.severity}</p>
            <p><strong>Description:</strong> Crime incident reported</p>
        </div>
    `);

    marker.addTo(window.CrimeSenseApp.map);
    window.CrimeSenseApp.markers.push(marker);
}

function addInfrastructureMarker(facility, type) {
    // Use original authentic circle markers for infrastructure
    const colors = {
        hospital: '#e74c3c',  // Red (like original crime markers)
        police: '#3498db',    // Blue (like original crime markers)
        fire: '#f39c12',      // Orange (like original crime markers)
        school: '#2c3e50'     // Dark blue (like original crime markers)
    };

    const marker = L.circleMarker([facility.lat, facility.lng], {
        radius: 8,
        fillColor: colors[type] || '#2c3e50',
        color: '#fff',
        weight: 1,
        opacity: 1,
        fillOpacity: 0.8
    });

    marker.bindPopup(`
        <div class="crime-popup">
            <h6>${facility.name.toUpperCase()}</h6>
            <p><strong>Type:</strong> ${type.charAt(0).toUpperCase() + type.slice(1)}</p>
            <p><strong>Description:</strong> ${type} facility</p>
        </div>
    `);

    // Add marker to cluster group instead of directly to map
    window.CrimeSenseApp.clusterGroup.addLayer(marker);
    window.CrimeSenseApp.markers.push(marker);
}

// Utility Functions
function clearMapLayers() {
    // Clear cluster group (which contains all markers)
    if (window.CrimeSenseApp.clusterGroup) {
        window.CrimeSenseApp.clusterGroup.clearLayers();
    }
    window.CrimeSenseApp.markers = [];

    // Clear GeoJSON layer
    if (window.CrimeSenseApp.geoJsonLayer) {
        window.CrimeSenseApp.map.removeLayer(window.CrimeSenseApp.geoJsonLayer);
        window.CrimeSenseApp.geoJsonLayer = null;
    }
}

function loadStateGeoJSON(stateId) {
    // Load state boundary GeoJSON
    console.log(`Loading GeoJSON for state: ${stateId}`);
    // This would load from /Maps/States/${stateId}/ directory
}

function loadCityGeoJSON(cityId) {
    // Load city boundary GeoJSON
    console.log(`Loading GeoJSON for city: ${cityId}`);

    // Use the server endpoint to serve the GeoJSON file
    const geoJsonUrl = `/geojson/cities/${cityId}`;

    fetch(geoJsonUrl)
        .then(response => {
            if (!response.ok) {
                throw new Error(`GeoJSON not found for ${cityId}`);
            }
            return response.json();
        })
        .then(geoJsonData => {
            console.log(` Loaded GeoJSON for ${cityId}`);

            // Add the GeoJSON layer to the map
            if (window.CrimeSenseApp.geoJsonLayer) {
                window.CrimeSenseApp.map.removeLayer(window.CrimeSenseApp.geoJsonLayer);
            }

            window.CrimeSenseApp.geoJsonLayer = L.geoJSON(geoJsonData, {
                style: {
                    color: '#3498db',
                    weight: 2,
                    opacity: 0.8,
                    fillColor: '#3498db',
                    fillOpacity: 0.1
                }
            }).addTo(window.CrimeSenseApp.map);

            // Fit map to the city boundaries
            window.CrimeSenseApp.map.fitBounds(window.CrimeSenseApp.geoJsonLayer.getBounds());
        })
        .catch(error => {
            console.warn(` Could not load GeoJSON for ${cityId}:`, error);
            // Continue without GeoJSON - just show the map centered on the city
            
            // Set a default view for the city if GeoJSON fails
            const cityCenters = {
                'chennai': [13.0827, 80.2707],
                'mumbai': [19.0760, 72.8777],
                'delhi': [28.6139, 77.2090],
                'banglore': [12.9716, 77.5946],
                'hyderabad': [17.3850, 78.4867],
                'navi-mumbai': [19.0330, 73.0297]
            };
            
            const coords = cityCenters[cityId.toLowerCase()] || [20.5937, 78.9629]; // Default to India center
            window.CrimeSenseApp.map.setView(coords, 12);
        });
}

function showLoading() {
    document.getElementById('loading').style.display = 'flex';
}

function hideLoading() {
    document.getElementById('loading').style.display = 'none';
}

function resetMapView() {
    switch(window.CrimeSenseApp.currentLevel) {
        case 'country':
            window.CrimeSenseApp.map.setView(window.CrimeSenseApp.config.defaultCenter, window.CrimeSenseApp.config.defaultZoom);
            break;
        case 'state':
            const stateConfig = window.CrimeSenseApp.config.states[window.CrimeSenseApp.currentState];
            if (stateConfig) {
                window.CrimeSenseApp.map.setView(stateConfig.center, stateConfig.zoom);
            }
            break;
        case 'city':
            const cityConfig = window.CrimeSenseApp.config.cities[window.CrimeSenseApp.currentCity];
            if (cityConfig) {
                window.CrimeSenseApp.map.setView(cityConfig.center, cityConfig.zoom);
            }
            break;
    }
}

function toggleFullscreen() {
    const mapContainer = document.querySelector('.map-container');
    if (!document.fullscreenElement) {
        mapContainer.requestFullscreen().catch(err => {
            console.log(`Error attempting to enable fullscreen: ${err.message}`);
        });
    } else {
        document.exitFullscreen();
    }
}

function applyFilters() {
    const threatClass = document.getElementById('threat-classification').value;
    const timeWindow = document.getElementById('time-window').value;
    const severityLevel = document.getElementById('severity-level').value;

    console.log('Applying filters:', { threatClass, timeWindow, severityLevel });

    // Show loading
    showLoading();

    // Simulate filter application
    setTimeout(() => {
        hideLoading();
        console.log('Filters applied successfully');
    }, 1000);
}
</script>
{% endblock %}